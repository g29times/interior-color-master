<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- WDXL Lubrifont å­—ä½“ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Bungee+Spice&family=Bungee+Tint&family=WDXL+Lubrifont+SC&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å®¤å†…è‰²å½©åˆ†æå¤§å¸ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom animations */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fade-in-up 0.5s ease-out forwards;
        }

        /* Loading color cycle animation - çº¢é»„è“ç»¿è½®æ’­ */
        @keyframes color-cycle {
            0%, 100% { color: #ef4444; opacity: 1; }      /* çº¢ */
            12.5% { color: #ef4444; opacity: 0.5; }
            25% { color: #eab308; opacity: 1; }          /* é»„ */
            37.5% { color: #eab308; opacity: 0.5; }
            50% { color: #3b82f6; opacity: 1; }          /* è“ */
            62.5% { color: #3b82f6; opacity: 0.5; }
            75% { color: #22c55e; opacity: 1; }          /* ç»¿ */
            87.5% { color: #22c55e; opacity: 0.5; }
        }
        .animate-color-pulse {
            animation: color-cycle 2s ease-in-out infinite;
        }

        .color-dot {
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s ease;
        }
        .color-dot:hover {
            transform: scale(1.15);
            cursor: pointer;
            z-index: 10;
        }
        .color-dot.active {
            transform: scale(1.25);
            box-shadow: 0 0 0 4px white, 0 0 0 6px currentColor;
            z-index: 10;
        }
        
        /* Highlight Box */
        .highlight-box {
            position: absolute;
            border: 3px solid white;
            box-shadow: 0 0 15px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,255,255,0.3);
            border-radius: 8px;
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none; 
            z-index: 30;
        }
        .highlight-box.show {
            opacity: 1;
            transform: scale(1);
        }

        /* Label */
        .highlight-label {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease 0.1s;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            backdrop-filter: blur(4px);
        }
        .highlight-box.show .highlight-label {
            opacity: 1;
        }

        .image-container {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1);
            background-color: #e5e7eb; /* Placeholder color */
            min-height: 300px;
            transition: all 0.3s ease;
        }
        
        .image-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            z-index: 20;
        }
        .container-active .image-overlay {
            opacity: 1;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #4f46e5;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal-bg {
            background-color: rgba(0, 0, 0, 0.5);
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4 relative">

    <!-- Settings Button -->
    <button onclick="toggleSettings()" class="absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-600 transition-colors rounded-full hover:bg-gray-100 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>

    <!-- Header -->
    <header class="text-center mb-8 max-w-2xl animate-fade-in">
        <h1 class="text-3xl md:text-4xl font-bold mb-3 text-gray-800" style="font-family: 'Bungee Spice', sans-serif;">Interior Color Master</h1>
        <p class="text-gray-500" style="font-family: 'Ma Shan Zheng', sans-serif;">å®¤å†…è‰²å½©åˆ†æå¤§å¸ˆ - ä¸Šä¼ å®¶å±…ç…§ç‰‡ï¼Œè‡ªåŠ¨æå–è‰²ç›˜ã€å®šä½ç‰©å“å¹¶è§£è¯»ç©ºé—´æ°›å›´ã€‚</p>
    </header>

    <!-- Input Section -->
    <div class="w-full max-w-xl bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-8 animate-fade-in" style="animation-delay: 0.1s;">
        <div class="flex flex-col gap-4">
            <!-- URL Input -->
            <div class="flex gap-2">
                <input type="text" id="image-url" placeholder="ç²˜è´´å›¾ç‰‡ URL (ä¾‹å¦‚: https://example.com/room.jpg)" 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all text-sm">
                <button id="url-btn" onclick="loadImageFromUrl()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors text-sm whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">
                    åŠ è½½ URL
                </button>
            </div>
            
            <div class="relative flex py-1 items-center">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">æˆ–è€…</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <!-- File Upload -->
            <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors group">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <p class="text-sm text-gray-500 group-hover:text-indigo-600 font-medium">ç‚¹å‡»ä¸Šä¼ æœ¬åœ°å›¾ç‰‡</p>
                    <p class="text-xs text-gray-400">æ”¯æŒ JPG, PNG (Max 5MB)</p>
                </div>
                <input id="image-upload" type="file" class="hidden" accept="image/*" onchange="handleFileUpload(this)" />
            </label>
        </div>
    </div>

    <!-- Main Content Area (Hidden initially) -->
    <div id="main-content" class="w-full max-w-5xl flex flex-col items-center hidden">
        
        <!-- Action Button -->
        <button id="analyze-btn" onclick="startAnalysis()" class="mb-8 px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full font-bold shadow-lg transform hover:scale-105 transition-all flex items-center gap-2">
            <span>âœ¨ å¼€å§‹ AI åˆ†æ</span>
        </button>

        <div id="loading-indicator" class="hidden flex-col items-center mb-8">
            <div class="loader mb-3"></div>
            <p class="font-medium text-sm animate-color-pulse" style="font-family: 'Ma Shan Zheng', sans-serif;">æ­£åœ¨è¯†åˆ«ç‰©ä½“ã€æå–é¢œè‰²...</p>
        </div>

        <!-- Layout: Image Left, Palette & Info Right (Desktop) -->
        <div class="flex flex-col lg:flex-row gap-8 w-full">
            
            <!-- Left: Image Canvas -->
            <div class="w-full lg:w-2/3">
                <div class="image-container bg-gray-200 flex items-center justify-center" id="img-container">
                    <p class="text-gray-400 text-sm absolute" id="img-placeholder-text">å›¾ç‰‡é¢„è§ˆåŒºåŸŸ</p>
                    <img id="main-image" src="" alt="Room Analysis" class="w-full h-auto block opacity-0 transition-opacity duration-300" onload="this.classList.remove('opacity-0'); document.getElementById('img-placeholder-text').style.display='none'">
                    <div class="image-overlay" id="img-overlay"></div>
                    <!-- Dynamic Highlight Boxes will be injected here -->
                    <div id="highlight-layer"></div>
                </div>
            </div>

            <!-- Right: Palette & Details -->
            <div class="w-full lg:w-1/3 flex flex-col gap-6">
                
                <!-- Color Palette -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">æ ¸å¿ƒè‰²ç›˜</h3>
                    <div id="palette-container" class="flex flex-wrap justify-center gap-3 min-h-[60px] items-center text-gray-400 text-sm italic">
                        ç­‰å¾…åˆ†æ...
                    </div>
                </div>
                
                <!-- Decor Suggestion (Contextual) -->
                <div id="decor-panel" class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100 opacity-50 pointer-events-none transition-all">
                    <h3 class="text-sm font-bold text-indigo-400 uppercase tracking-wider mb-2">æ­é…å»ºè®®</h3>
                    <p id="decor-text" class="text-indigo-900 text-sm font-medium">ç‚¹å‡»ä¸Šæ–¹è‰²ç‚¹æŸ¥çœ‹è¯¦æƒ…</p>
                    <p id="decor-desc" class="text-indigo-700 text-xs mt-1" style="font-family: 'Ma Shan Zheng', sans-serif; font-size: 1rem;">é€‰å®šé¢œè‰²åï¼ŒæŸ¥çœ‹ AI å¯¹è¯¥é¢œè‰²åœ¨ç©ºé—´ä¸­è¿ç”¨çš„ç‚¹è¯„ã€‚</p>
                </div>

                <!-- AI Vibe Description -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex-grow">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">âœ¨ ç©ºé—´æ°›å›´è§£è¯»</h3>
                    <div id="vibe-content" class="text-gray-600 text-sm leading-relaxed prose" style="font-family: 'Ma Shan Zheng', sans-serif; font-size: 1.5rem;">
                        <p class="italic text-gray-400">AI åˆ†æå®Œæˆåï¼Œè¿™é‡Œå°†æ˜¾ç¤ºå¯¹æˆ¿é—´é£æ ¼ã€å…‰çº¿å’Œæƒ…æ„Ÿæ°›å›´çš„ä¸“ä¸šè§£è¯»ã€‚</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Error Toast -->
    <div id="error-toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full shadow-xl text-sm font-medium hidden z-50 transition-opacity duration-300 flex items-center gap-2">
        <span id="error-msg">Error message</span>
        <button onclick="toggleSettings()" id="error-action" class="underline text-white font-bold ml-2 hidden">è®¾ç½® Key</button>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 modal-bg z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">è®¾ç½® API å¯†é’¥</h3>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="text-sm text-gray-500 mb-4">
                å¦‚æœé‡åˆ° 401/403 é”™è¯¯ï¼Œè¯·åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„ Google Gemini API Keyã€‚æ‚¨çš„å¯†é’¥ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚
            </p>
            <input type="password" id="custom-api-key" placeholder="AIzaSy..." 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none mb-4 font-mono text-sm">
            <div class="flex justify-end gap-2">
                <button onclick="toggleSettings()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // System injected, DO NOT CHANGE
        
        // State
        let currentImageBase64 = null; // Without prefix for API
        let currentImageDataUrl = null; // With prefix for IMG tag
        let analysisData = null;
        let activeColorIndex = null;

        // --- Settings / API Key Logic ---

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const input = document.getElementById('custom-api-key');
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                // Load existing key
                input.value = localStorage.getItem('gemini_custom_key') || '';
            } else {
                modal.classList.add('hidden');
            }
        }

        function saveApiKey() {
            const key = document.getElementById('custom-api-key').value.trim();
            if (key) {
                localStorage.setItem('gemini_custom_key', key);
            } else {
                localStorage.removeItem('gemini_custom_key');
            }
            toggleSettings();
            showError("API Key å·²ä¿å­˜", false); // Show success toast
        }

        function getEffectiveApiKey() {
            const customKey = localStorage.getItem('gemini_custom_key');
            if (customKey && customKey.length > 5) return customKey;
            return apiKey;
        }

        // --- Image Handling ---

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    setImage(e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function loadImageFromUrl() {
            const urlInput = document.getElementById('image-url');
            const url = urlInput.value.trim();
            if (!url) return showError('è¯·è¾“å…¥æœ‰æ•ˆçš„ URL');
            
            const btn = document.getElementById('url-btn');
            const originalText = btn.innerText;
            btn.innerText = "åŠ è½½ä¸­...";
            btn.disabled = true;

            try {
                let blob;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error('Network response was not ok');
                    blob = await res.blob();
                } catch (directError) {
                    console.log("Direct fetch failed, trying proxy fallback...", directError);
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
                    const res = await fetch(proxyUrl);
                    if (!res.ok) throw new Error('Proxy response was not ok');
                    blob = await res.blob();
                }

                const reader = new FileReader();
                reader.onloadend = () => setImage(reader.result);
                reader.readAsDataURL(blob);

            } catch (err) {
                console.error(err);
                showError('æ— æ³•åŠ è½½å›¾ç‰‡ï¼Œè¯·å°è¯•ä¸‹è½½åä¸Šä¼ ã€‚');
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function setImage(dataUrl) {
            currentImageDataUrl = dataUrl;
            currentImageBase64 = dataUrl.split(',')[1];
            
            const img = document.getElementById('main-image');
            img.src = dataUrl;
            
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('highlight-layer').innerHTML = '';
            document.getElementById('palette-container').innerHTML = '<span class="text-gray-400 italic text-sm">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹åˆ†æ</span>';
            document.getElementById('vibe-content').innerHTML = '<p class="italic text-gray-400">å‡†å¤‡å°±ç»ª...</p>';
            resetActiveState();
            
            setTimeout(() => document.getElementById('main-content').scrollIntoView({ behavior: 'smooth' }), 100);
        }

        // --- Interaction ---

        function toggleColor(index) {
            const boxes = document.querySelectorAll('.highlight-box');
            const dots = document.querySelectorAll('.color-dot');
            const container = document.getElementById('img-container');
            const decorPanel = document.getElementById('decor-panel');
            const decorText = document.getElementById('decor-text');
            const decorDesc = document.getElementById('decor-desc');

            if (activeColorIndex === index) {
                resetActiveState();
                return;
            }

            resetActiveState();
            activeColorIndex = index;
            if(dots[index]) dots[index].classList.add('active');
            
            const targetBox = document.getElementById(`box-${index}`);
            if (targetBox) {
                container.classList.add('container-active');
                targetBox.classList.add('show');
            }

            if (analysisData && analysisData.palette[index]) {
                const item = analysisData.palette[index];
                decorPanel.classList.remove('opacity-50', 'pointer-events-none');
                decorText.innerText = `${item.color_name} Â· ${item.object_name}`;
                decorDesc.innerText = item.style_reason;
                decorPanel.style.backgroundColor = hexToRgba(item.color_hex, 0.1);
                decorPanel.style.borderColor = hexToRgba(item.color_hex, 0.2);
            }
        }

        function resetActiveState() {
            activeColorIndex = null;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.highlight-box').forEach(b => b.classList.remove('show'));
            document.getElementById('img-container').classList.remove('container-active');
            
            const p = document.getElementById('decor-panel');
            p.classList.add('opacity-50', 'pointer-events-none');
            p.style.backgroundColor = ''; 
            p.style.borderColor = '';
            document.getElementById('decor-text').innerText = "ç‚¹å‡»ä¸Šæ–¹è‰²ç‚¹æŸ¥çœ‹è¯¦æƒ…";
            document.getElementById('decor-desc').innerText = "é€‰å®šé¢œè‰²åï¼ŒæŸ¥çœ‹ AI å¯¹è¯¥é¢œè‰²åœ¨ç©ºé—´ä¸­è¿ç”¨çš„ç‚¹è¯„ã€‚";
        }

        // --- Gemini AI ---

        async function startAnalysis() {
            if (!currentImageBase64) return showError("è¯·å…ˆåŠ è½½å›¾ç‰‡");
            
            const effectiveKey = getEffectiveApiKey();
            if (!effectiveKey) {
                toggleSettings();
                return showError("è¯·å…ˆè®¾ç½® API Key", true);
            }

            const btn = document.getElementById('analyze-btn');
            const loader = document.getElementById('loading-indicator');
            
            btn.classList.add('hidden');
            loader.classList.remove('hidden');
            loader.classList.add('flex');

            const mimeType = currentImageDataUrl.match(/data:([^;]+);base64,/)?.[1] || 'image/jpeg';

            try {
                const schema = {
                    type: "OBJECT",
                    properties: {
                        palette: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    color_hex: { type: "STRING" },
                                    color_name: { type: "STRING" },
                                    object_name: { type: "STRING" },
                                    style_reason: { type: "STRING" },
                                    box_2d: {
                                        type: "ARRAY",
                                        items: { type: "INTEGER" },
                                        description: "Bounding box [ymin, xmin, ymax, xmax] scaled 0-1000"
                                    }
                                },
                                required: ["color_hex", "color_name", "object_name", "box_2d", "style_reason"]
                            }
                        },
                        vibe_description: { type: "STRING" }
                    },
                    required: ["palette", "vibe_description"]
                };

                const prompt = `
                Analyze this interior design image. 
                1. Identify 5 distinct dominant colors that define the room's palette.
                2. For EACH color, identify ONE specific, visible object in the room that is the best example of that color (e.g., a sofa, a pillow, a wall section, a lamp, a rug).
                3. Provide the bounding box for that specific object (ymin, xmin, ymax, xmax) on a scale of 0 to 1000.
                4. Provide a 'style_reason' (in Chinese) explaining why this object/color is important to the room's design (e.g. "Serves as a grounding element").
                5. Provide a 'vibe_description' (in Chinese): A professional 2-3 sentence summary of the room's overall atmosphere and style.
                Return strictly JSON.
                `;

                let attempts = 0;
                const maxAttempts = 3;
                let success = false;

                while (attempts < maxAttempts && !success) {
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${effectiveKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: prompt },
                                        { inline_data: { mime_type: mimeType, data: currentImageBase64 } }
                                    ]
                                }],
                                generationConfig: {
                                    response_mime_type: "application/json",
                                    response_schema: schema
                                }
                            })
                        });

                        if (!response.ok) {
                            // Catch 401 specifically
                            if (response.status === 401 || response.status === 403) {
                                throw new Error("AUTH_ERROR");
                            }
                            const errorBody = await response.text();
                            throw new Error(`Status ${response.status}: ${errorBody}`);
                        }

                        const data = await response.json();
                        const jsonText = data.candidates[0].content.parts[0].text;
                        analysisData = JSON.parse(jsonText);
                        
                        renderResults();
                        success = true;

                    } catch (attemptError) {
                        if (attemptError.message === "AUTH_ERROR") throw attemptError; // Don't retry auth errors
                        
                        console.warn(`Attempt ${attempts + 1} failed:`, attemptError);
                        attempts++;
                        if (attempts >= maxAttempts) throw attemptError;
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                }

            } catch (err) {
                console.error(err);
                if (err.message === "AUTH_ERROR") {
                    showError("è®¤è¯å¤±è´¥ (401): è¯·æ£€æŸ¥ API Keyã€‚", true);
                    toggleSettings(); // Auto open settings
                } else {
                    let msg = "åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚";
                    if (err.message.includes("400")) msg = "å›¾ç‰‡æ ¼å¼å¯èƒ½ä¸æ”¯æŒã€‚";
                    else if (err.message.includes("429")) msg = "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åã€‚";
                    showError(msg);
                }
                btn.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                loader.classList.remove('flex');
            }
        }

        function renderResults() {
            if (!analysisData) return;

            document.getElementById('vibe-content').innerHTML = `<p>${analysisData.vibe_description}</p>`;
            const paletteContainer = document.getElementById('palette-container');
            paletteContainer.innerHTML = '';
            
            analysisData.palette.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col items-center gap-2 group';
                
                const dot = document.createElement('div');
                dot.className = 'color-dot w-10 h-10 md:w-12 md:h-12 rounded-full border border-gray-100 shadow-sm';
                dot.style.backgroundColor = item.color_hex;
                dot.style.color = item.color_hex; 
                dot.onclick = () => toggleColor(index);
                
                const label = document.createElement('span');
                label.className = 'text-xs text-gray-400 font-medium group-hover:text-gray-600 transition-colors max-w-[60px] truncate text-center';
                label.innerText = item.color_name;

                wrapper.appendChild(dot);
                wrapper.appendChild(label);
                paletteContainer.appendChild(wrapper);
            });

            const layer = document.getElementById('highlight-layer');
            layer.innerHTML = '';

            analysisData.palette.forEach((item, index) => {
                const box = document.createElement('div');
                box.className = 'highlight-box';
                box.id = `box-${index}`;
                box.style.borderColor = item.color_hex;
                
                const [ymin, xmin, ymax, xmax] = item.box_2d;
                const top = ymin / 10;
                const left = xmin / 10;
                const height = (ymax - ymin) / 10;
                const width = (xmax - xmin) / 10;

                box.style.top = `${top}%`;
                box.style.left = `${left}%`;
                box.style.height = `${height}%`;
                box.style.width = `${width}%`;

                const label = document.createElement('div');
                label.className = 'highlight-label';
                label.innerText = item.object_name;
                
                box.appendChild(label);
                layer.appendChild(box);
            });
            
            const btn = document.getElementById('analyze-btn');
            btn.innerText = "ğŸ”„ é‡æ–°åˆ†æ";
            btn.classList.remove('hidden');
            btn.classList.remove('bg-indigo-600', 'text-white');
            btn.classList.add('bg-white', 'text-indigo-600', 'border', 'border-indigo-200');
        }

        // --- Utils ---

        function showError(msg, showSettingsLink = false) {
            const toast = document.getElementById('error-toast');
            const msgSpan = document.getElementById('error-msg');
            const actionBtn = document.getElementById('error-action');

            msgSpan.innerText = msg;
            if (showSettingsLink) {
                actionBtn.classList.remove('hidden');
                toast.classList.add('bg-orange-500'); // Warning color
                toast.classList.remove('bg-red-500');
            } else {
                actionBtn.classList.add('hidden');
                toast.classList.add('bg-red-500');
                toast.classList.remove('bg-orange-500');
            }

            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 5000);
        }

        function hexToRgba(hex, alpha) {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return `rgba(${r},${g},${b},${alpha})`;
        }
    </script>
</body>
</html>